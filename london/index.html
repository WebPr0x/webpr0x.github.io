<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Climber: Wall Street Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for Stock Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: 'rgba(30, 41, 59, 0.7)',
                        glassBorder: 'rgba(255, 255, 255, 0.1)',
                        neonBlue: '#3b82f6',
                        neonGreen: '#22c55e',
                        neonPurple: '#a855f7',
                        neonGold: '#eab308',
                        neonRed: '#ef4444',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
        }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }
        .click-particle {
            position: absolute;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            z-index: 100;
        }
        .crit-particle {
            font-size: 1.5rem;
            color: #eab308;
            text-shadow: 0 0 15px rgba(234, 179, 8, 0.8);
            animation: floatUp 1s ease-out forwards;
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @keyframes boss-hit {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(0.95); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } /* Flash red/orange */
            100% { transform: scale(1); filter: brightness(1); }
        }
        .boss-damaged { animation: boss-hit 0.2s ease-out; }

        /* Rarity Cards */
        .item-card { transition: all 0.2s; }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3); }
        
        .rarity-common { border-top: 3px solid #94a3b8; background: linear-gradient(180deg, rgba(148,163,184,0.05) 0%, rgba(15,23,42,0.4) 100%); }
        .rarity-uncommon { border-top: 3px solid #22c55e; background: linear-gradient(180deg, rgba(34,197,94,0.05) 0%, rgba(15,23,42,0.4) 100%); }
        .rarity-rare { border-top: 3px solid #3b82f6; background: linear-gradient(180deg, rgba(59,130,246,0.05) 0%, rgba(15,23,42,0.4) 100%); }
        .rarity-epic { border-top: 3px solid #a855f7; background: linear-gradient(180deg, rgba(168,85,247,0.05) 0%, rgba(15,23,42,0.4) 100%); }
        .rarity-legendary { border-top: 3px solid #eab308; background: linear-gradient(180deg, rgba(234,179,8,0.1) 0%, rgba(15,23,42,0.4) 100%); box-shadow: 0 0 15px rgba(234, 179, 8, 0.1); }

        .quality-shoddy { color: #94a3b8; }
        .quality-standard { color: #fff; }
        .quality-mint { color: #22c55e; text-shadow: 0 0 5px rgba(34,197,94,0.5); }
        .quality-pristine { color: #eab308; text-shadow: 0 0 8px rgba(234,179,8,0.6); font-weight: bold; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row select-none font-sans">

    <!-- AUTH SCREEN OVERLAY -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        <div class="glass-panel p-8 rounded-2xl w-full max-w-md border border-white/10 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-green-500"></div>
            
            <div class="text-center mb-8">
                <i class="fa-solid fa-briefcase text-5xl text-blue-400 mb-4 drop-shadow-lg"></i>
                <h1 class="text-3xl font-bold text-white mb-2">Corporate Climber</h1>
                <p class="text-slate-400 text-sm">Wall Street Edition</p>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="animate-fade-in">
                <h2 class="text-xl font-bold text-white mb-4">Login</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Username</label>
                        <input type="text" id="login-user" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:border-blue-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Password</label>
                        <input type="password" id="login-pass" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:border-blue-500 outline-none transition-colors">
                    </div>
                    <button onclick="auth.login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition-transform active:scale-95">Enter Market</button>
                    <p class="text-center text-sm text-slate-400">New here? <a href="#" onclick="auth.toggle('register')" class="text-blue-400 hover:underline">Register</a></p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden animate-fade-in">
                <h2 class="text-xl font-bold text-white mb-4">Create Account</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Choose Username</label>
                        <input type="text" id="reg-user" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:border-green-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Set Password</label>
                        <input type="password" id="reg-pass" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:border-green-500 outline-none transition-colors">
                    </div>
                    <button onclick="auth.register()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg transition-transform active:scale-95">Start Career</button>
                    <p class="text-center text-sm text-slate-400">Have an account? <a href="#" onclick="auth.toggle('login')" class="text-green-400 hover:underline">Login</a></p>
                </div>
            </div>
            
            <div id="auth-error" class="mt-4 text-center text-red-400 text-sm font-bold hidden"></div>
        </div>
    </div>

    <!-- LEFT PANEL: The Clicker -->
    <div class="w-full md:w-1/3 flex flex-col glass-panel relative z-20 border-r-0 md:border-r border-b md:border-b-0 border-white/10">
        
        <!-- Stats Header -->
        <div class="glass-header p-5 z-30">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Liquid Assets</div>
                    <div class="text-3xl font-mono font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600">$<span id="money-display">0.00</span></div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Passive Income</div>
                    <div class="text-lg font-mono font-semibold text-blue-400">+$<span id="cps-display">0.00</span>/s</div>
                </div>
            </div>
        </div>

        <!-- The Big Clicker -->
        <div class="flex-1 flex flex-col items-center justify-center relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-opacity-5">
            <!-- Radial Glow -->
            <div class="absolute inset-0 bg-gradient-to-b from-blue-500/5 to-purple-500/5 pointer-events-none"></div>

            <!-- Crit Meter -->
            <div id="crit-meter-container" class="mb-6 w-48 transition-all duration-300 transform">
                <div class="flex justify-between text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">
                    <span>Crit Charge</span>
                    <span id="crit-text" class="font-mono text-neonGold">0/50</span>
                </div>
                <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden border border-white/10 relative shadow-inner">
                    <div id="crit-bar" class="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 transition-all duration-100 ease-out" style="width: 0%"></div>
                    <!-- Glow effect when full -->
                    <div id="crit-glow" class="absolute inset-0 bg-yellow-400/50 animate-pulse hidden"></div>
                </div>
            </div>

            <button id="click-target" class="relative group w-56 h-56 rounded-full transition-all duration-100 transform active:scale-95 outline-none">
                <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-slate-800 to-slate-700 shadow-[0_20px_50px_-12px_rgba(0,0,0,0.7)] group-hover:shadow-[0_20px_50px_-12px_rgba(59,130,246,0.3)] transition-shadow duration-300 border border-white/5"></div>
                <div class="absolute inset-2 rounded-full bg-slate-900 flex items-center justify-center border border-white/5 group-active:bg-slate-950">
                    <i class="fa-solid fa-briefcase text-7xl text-slate-500 group-hover:text-blue-400 transition-colors duration-300 drop-shadow-lg"></i>
                </div>
            </button>
            
            <div class="text-center mt-8 space-y-1">
                <p class="text-slate-500 text-xs uppercase tracking-widest font-bold">Click Value</p>
                <p class="text-2xl font-mono font-bold text-white">$<span id="click-power-display">1</span></p>
            </div>
        </div>

        <!-- Mini Portfolio Summary -->
        <div class="p-4 glass-header border-t border-white/10">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between">
                <span>Recent Acquisitions</span>
                <span id="inventory-count-mini" class="text-slate-500">0 Items</span>
            </h3>
            <div id="recent-loot" class="flex gap-2 overflow-x-auto pb-1 min-h-[50px] scrollbar-hide">
                <div class="text-xs text-slate-600 italic py-2">Inventory empty...</div>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Dashboard -->
    <div class="w-full md:w-2/3 flex flex-col h-full bg-slate-900/50 backdrop-blur-sm relative">
        
        <!-- Navigation Tabs -->
        <div class="flex border-b border-white/10 bg-slate-900/80 backdrop-blur-md sticky top-0 z-20 overflow-x-auto">
            <button onclick="switchTab('quests')" class="tab-btn active px-6 py-4 text-xs font-bold uppercase tracking-widest text-blue-400 border-b-2 border-blue-500 hover:bg-white/5 transition-all whitespace-nowrap" data-tab="quests"><i class="fa-solid fa-scroll mr-2"></i>Quests</button>
            <button onclick="switchTab('upgrades')" class="tab-btn px-6 py-4 text-xs font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:bg-white/5 transition-all whitespace-nowrap" data-tab="upgrades"><i class="fa-solid fa-bolt mr-2"></i>Upgrades</button>
            <button onclick="switchTab('guild')" class="tab-btn px-6 py-4 text-xs font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:bg-white/5 transition-all whitespace-nowrap" data-tab="guild"><i class="fa-solid fa-users mr-2"></i>Guilds</button>
            <button onclick="switchTab('stocks')" class="tab-btn px-6 py-4 text-xs font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:bg-white/5 transition-all whitespace-nowrap" data-tab="stocks"><i class="fa-solid fa-chart-line mr-2"></i>Stocks</button>
            <button onclick="switchTab('shop')" class="tab-btn px-6 py-4 text-xs font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:bg-white/5 transition-all whitespace-nowrap" data-tab="shop"><i class="fa-solid fa-cart-shopping mr-2"></i>Cases</button>
            <button onclick="switchTab('inventory')" class="tab-btn px-6 py-4 text-xs font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:bg-white/5 transition-all whitespace-nowrap" data-tab="inventory"><i class="fa-solid fa-box-open mr-2"></i>Assets</button>
            <button onclick="switchTab('market')" class="tab-btn px-6 py-4 text-xs font-bold uppercase tracking-widest text-slate-400 border-b-2 border-transparent hover:bg-white/5 transition-all whitespace-nowrap" data-tab="market"><i class="fa-solid fa-globe mr-2"></i>Market</button>
            
            <!-- User Profile / Logout -->
             <div class="ml-auto flex items-center px-4 border-l border-white/10">
                 <div class="flex flex-col items-end mr-3">
                     <span id="profile-name" class="text-xs font-bold text-blue-400 hidden md:block">Guest</span>
                     <span id="influence-display" class="text-[10px] text-purple-400 font-bold hidden md:block">0 Influence</span>
                 </div>
                 <button onclick="auth.logout()" class="text-xs text-slate-500 hover:text-red-400" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
             </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-6 relative bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-800/20 to-slate-900/0">
            
            <!-- QUESTS TAB -->
            <div id="tab-quests" class="tab-content block animate-fade-in">
                <h2 class="text-2xl font-bold mb-6 text-white flex items-center"><span class="bg-blue-500 w-1 h-8 mr-3 rounded-full"></span>Active Contracts</h2>
                <div id="quest-page-content" class="space-y-6">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- UPGRADES TAB -->
            <div id="tab-upgrades" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center"><span class="bg-blue-500 w-1 h-8 mr-3 rounded-full"></span>Production Upgrades</h2>
                    <button id="prestige-btn" onclick="game.prestige()" class="hidden bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded font-bold text-xs shadow-lg shadow-purple-900/50 animate-pulse">
                        <i class="fa-solid fa-medal mr-2"></i>RETIRE (Reset for Influence)
                    </button>
                </div>
                <div id="upgrades-list" class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- GUILDS TAB -->
            <div id="tab-guild" class="tab-content hidden animate-fade-in h-full">
                <!-- Content injected by JS -->
                <div id="guild-container" class="h-full flex flex-col"></div>
            </div>

            <!-- STOCKS TAB -->
            <div id="tab-stocks" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white flex items-center"><span class="bg-green-500 w-1 h-8 mr-3 rounded-full"></span>Stock Exchange</h2>
                        <p class="text-slate-400 text-sm mt-1 ml-4">Buy low, sell high. Market refreshes every 5s.</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-slate-500 uppercase">Portfolio Value</div>
                        <div class="text-xl font-mono text-white">$<span id="portfolio-val">0</span></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="stock-container"></div>
            </div>

            <!-- SHOP TAB -->
            <div id="tab-shop" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center"><span class="bg-yellow-500 w-1 h-8 mr-3 rounded-full"></span>Executive Shop</h2>
                    
                    <!-- Pity Timer -->
                    <div class="w-48 text-right">
                        <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Guaranteed Epic+</div>
                        <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden border border-white/10">
                            <div id="pity-bar" class="h-full bg-purple-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="text-[10px] text-slate-500 mt-1"><span id="pity-count">0</span>/20 Opens</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Case 1 -->
                    <div class="glass-panel rounded-2xl p-6 flex flex-col items-center text-center hover:bg-white/5 transition-colors group relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-900/80 pointer-events-none"></div>
                        <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mb-4 text-3xl text-slate-400 group-hover:scale-110 transition-transform relative z-10">
                            <i class="fa-solid fa-suitcase"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white relative z-10">Intern's Case</h3>
                        <p class="text-xs text-slate-400 mb-6 h-8 relative z-10">Mostly junk, but cheap.</p>
                        <button onclick="game.buyBriefcase('basic')" class="relative z-10 w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold text-sm transition-colors border border-white/5">$100</button>
                    </div>

                    <!-- Case 2 -->
                    <div class="glass-panel rounded-2xl p-6 flex flex-col items-center text-center hover:bg-white/5 transition-colors group relative overflow-hidden border-blue-500/30">
                        <div class="absolute top-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
                        <div class="w-20 h-20 rounded-full bg-blue-900/20 flex items-center justify-center mb-4 text-3xl text-blue-400 group-hover:scale-110 transition-transform relative z-10 shadow-[0_0_20px_rgba(59,130,246,0.3)]">
                            <i class="fa-solid fa-briefcase"></i>
                        </div>
                        <h3 class="text-lg font-bold text-blue-100 relative z-10">Manager's Case</h3>
                        <p class="text-xs text-blue-200/60 mb-6 h-8 relative z-10">Good chance for Rares.</p>
                        <button onclick="game.buyBriefcase('business')" class="relative z-10 w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-sm transition-colors shadow-lg shadow-blue-900/20 text-white">$1,500</button>
                    </div>

                    <!-- Case 3 -->
                    <div class="glass-panel rounded-2xl p-6 flex flex-col items-center text-center hover:bg-white/5 transition-colors group relative overflow-hidden border-yellow-500/30">
                        <div class="absolute top-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent opacity-50"></div>
                        <div class="w-20 h-20 rounded-full bg-yellow-900/20 flex items-center justify-center mb-4 text-3xl text-yellow-400 group-hover:scale-110 transition-transform relative z-10 shadow-[0_0_20px_rgba(234,179,8,0.3)]">
                            <i class="fa-solid fa-gem"></i>
                        </div>
                        <h3 class="text-lg font-bold text-yellow-100 relative z-10">Executive Case</h3>
                        <p class="text-xs text-yellow-200/60 mb-6 h-8 relative z-10">Epics & Legendaries.</p>
                        <button onclick="game.buyBriefcase('executive')" class="relative z-10 w-full py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold text-sm transition-colors shadow-lg shadow-yellow-900/20 text-black">$10,000</button>
                    </div>
                </div>

                <div class="mt-8 glass-panel p-6 rounded-xl">
                    <h4 class="font-bold text-white mb-4 text-sm uppercase tracking-widest">Loot Table Odds</h4>
                    <div class="flex flex-wrap gap-4 text-xs font-mono">
                        <span class="px-3 py-1 rounded bg-slate-800 text-slate-400 border border-slate-700">Common (60%)</span>
                        <span class="px-3 py-1 rounded bg-green-900/30 text-green-400 border border-green-800/50">Uncommon (25%)</span>
                        <span class="px-3 py-1 rounded bg-blue-900/30 text-blue-400 border border-blue-800/50">Rare (10%)</span>
                        <span class="px-3 py-1 rounded bg-purple-900/30 text-purple-400 border border-purple-800/50">Epic (4%)</span>
                        <span class="px-3 py-1 rounded bg-yellow-900/30 text-yellow-400 border border-yellow-800/50">Legendary (1%)</span>
                    </div>
                </div>
            </div>

            <!-- INVENTORY TAB -->
            <div id="tab-inventory" class="tab-content hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center"><span class="bg-purple-500 w-1 h-8 mr-3 rounded-full"></span>Asset Portfolio</h2>
                    <span class="text-xs font-mono px-3 py-1 bg-white/10 rounded-full text-slate-300" id="inventory-count">0 items</span>
                </div>
                
                <!-- Collections Summary -->
                <div id="collection-summary" class="mb-4 glass-panel p-4 rounded-xl flex gap-4 overflow-x-auto">
                    <!-- Injected via JS -->
                </div>

                <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- MARKET TAB -->
            <div id="tab-market" class="tab-content hidden flex flex-col h-full animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center"><span class="bg-indigo-500 w-1 h-8 mr-3 rounded-full"></span>Global Trade</h2>
                    <button onclick="market.refreshListings()" class="text-xs font-bold uppercase tracking-wider bg-white/10 hover:bg-white/20 px-4 py-2 rounded transition-colors text-white"><i class="fa-solid fa-rotate mr-2"></i>Refresh</button>
                </div>
                
                <div class="flex-1 glass-panel rounded-xl overflow-hidden border border-white/10">
                    <div class="bg-slate-900/80 p-3 flex justify-between items-center border-b border-white/5 text-xs text-slate-500 font-mono">
                         <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> SERVER: ONLINE</span>
                         <span>LATENCY: <span id="ping">24</span>ms</span>
                    </div>
                    <div class="overflow-y-auto max-h-[600px]">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-white/5 text-slate-300 sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th class="p-4 font-semibold">Item Details</th>
                                    <th class="p-4 font-semibold hidden sm:table-cell">Seller</th>
                                    <th class="p-4 font-semibold">Price</th>
                                    <th class="p-4 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="market-listings" class="divide-y divide-white/5">
                                <!-- Market Listings Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GLOBAL CHAT TAB -->
            <div id="tab-chat" class="tab-content hidden flex flex-col h-full absolute inset-0 p-0 md:p-6 animate-fade-in">
                 <div class="md:hidden p-4 border-b border-white/10 bg-slate-900/90 sticky top-0 z-10">
                     <h2 class="text-xl font-bold text-white">Global Chat</h2>
                 </div>
                <div class="flex-1 glass-panel md:rounded-xl border-x-0 md:border border-white/10 overflow-hidden flex flex-col h-full">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-sm scroll-smooth">
                        <!-- Messages -->
                    </div>
                    <div class="p-4 bg-slate-900/80 border-t border-white/10 flex gap-3">
                        <input type="text" id="chat-input" placeholder="Broadcast message..." class="flex-1 bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors">
                        <button onclick="chat.sendMessage()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg text-white font-bold transition-all shadow-lg shadow-blue-900/20"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- LISTING MODAL -->
    <div id="listing-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 hidden backdrop-blur-sm animate-fade-in">
        <div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 transform transition-all scale-100 border border-white/10">
            <h3 class="text-xl font-bold text-white mb-2">List Item for Sale</h3>
            <p class="text-sm text-slate-400 mb-4">Set your price for <span id="modal-item-name" class="text-blue-400 font-bold">Item Name</span>.</p>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Price ($)</label>
                <input type="number" id="listing-price-input" class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 font-mono" placeholder="Enter amount...">
            </div>
            
            <p class="text-xs text-slate-500 mb-4 italic">Fair market value is approx <span id="modal-fair-val" class="text-slate-300">$0</span>. Bots may buy if priced reasonably.</p>

            <div class="flex gap-3">
                <button onclick="ui.closeListingModal()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-bold text-white transition-colors">Cancel</button>
                <button onclick="game.confirmListing()" class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-bold text-white transition-colors shadow-lg shadow-green-900/20">List Item</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script>
        /**
         * ------------------------------------------------------------------
         * CONFIG & DATA
         * ------------------------------------------------------------------
         */
        const RARITY = {
            COMMON: { id: 'common', color: 'text-slate-400', class: 'rarity-common', mult: 1, prob: 0.60, buffVal: 1 },
            UNCOMMON: { id: 'uncommon', color: 'text-green-400', class: 'rarity-uncommon', mult: 1.5, prob: 0.25, buffVal: 2 },
            RARE: { id: 'rare', color: 'text-blue-400', class: 'rarity-rare', mult: 5, prob: 0.10, buffVal: 5 },
            EPIC: { id: 'epic', color: 'text-purple-400', class: 'rarity-epic', mult: 20, prob: 0.04, buffVal: 15 },
            LEGENDARY: { id: 'legendary', color: 'text-yellow-400', class: 'rarity-legendary', mult: 100, prob: 0.01, buffVal: 50 }
        };

        const QUALITIES = {
            SHODDY: { id: 'shoddy', name: 'Shoddy', mult: 0.5, class: 'quality-shoddy' },
            STANDARD: { id: 'standard', name: 'Standard', mult: 1.0, class: 'quality-standard' },
            MINT: { id: 'mint', name: 'Mint', mult: 1.5, class: 'quality-mint' },
            PRISTINE: { id: 'pristine', name: 'Pristine', mult: 2.0, class: 'quality-pristine' }
        };

        const ITEM_SETS = {
            JUNIOR: { name: "Desk Jockey", items: ["Red Stapler", "Coffee Mug", "Paperclip"], bonus: 0.2, desc: "+20% CPS" },
            MID: { name: "Middle Mgmt", items: ["Calculator", "Fountain Pen", "Wristwatch"], bonus: 0.5, desc: "+50% Click Power" },
            EXEC: { name: "Executive Suite", items: ["Briefcase", "Smartphone", "Laptop"], bonus: 1.0, desc: "+100% Global Income" },
            TYCOON: { name: "The 1 Percent", items: ["Diamond"], bonus: 2.0, desc: "+200% All Stats" }
        };

        const ITEMS = [
            { name: "Red Stapler", icon: "fa-stapler", set: "JUNIOR" },
            { name: "Coffee Mug", icon: "fa-mug-hot", set: "JUNIOR" },
            { name: "Paperclip", icon: "fa-paperclip", set: "JUNIOR" },
            { name: "Calculator", icon: "fa-calculator", set: "MID" },
            { name: "Fountain Pen", icon: "fa-pen-fancy", set: "MID" },
            { name: "Wristwatch", icon: "fa-clock", set: "MID" },
            { name: "Briefcase", icon: "fa-suitcase", set: "EXEC" },
            { name: "Smartphone", icon: "fa-mobile-screen", set: "EXEC" },
            { name: "Laptop", icon: "fa-laptop", set: "EXEC" },
            { name: "Diamond", icon: "fa-gem", set: "TYCOON" }
        ];

        const UPGRADES = [
            { id: 'click1', name: 'Ergonomic Mouse', type: 'click', cost: 50, val: 1, icon: 'fa-computer-mouse', desc: "+1 Click Power" },
            { id: 'cps1', name: 'Unpaid Intern', type: 'cps', cost: 100, val: 5, icon: 'fa-user', desc: "+5 $/sec" },
            { id: 'click2', name: 'Mechanical Keys', type: 'click', cost: 500, val: 5, icon: 'fa-keyboard', desc: "+5 Click Power" },
            { id: 'cps2', name: 'Shift Manager', type: 'cps', cost: 1200, val: 25, icon: 'fa-user-tie', desc: "+25 $/sec" },
            { id: 'click3', name: 'Gaming Chair', type: 'click', cost: 3000, val: 20, icon: 'fa-chair', desc: "+20 Click Power" },
            { id: 'cps3', name: 'Regional Director', type: 'cps', cost: 8000, val: 100, icon: 'fa-building', desc: "+100 $/sec" },
            { id: 'stock1', name: 'Insider Info', type: 'click', cost: 15000, val: 50, icon: 'fa-user-secret', desc: "+50 Click Power" },
            { id: 'cps4', name: 'Offshore Account', type: 'cps', cost: 25000, val: 400, icon: 'fa-landmark', desc: "+400 $/sec" },
            { id: 'cps5', name: 'AI Trading Bot', type: 'cps', cost: 100000, val: 1200, icon: 'fa-robot', desc: "+1,200 $/sec" }
        ];

        const STOCKS_DATA = [
            { symbol: 'TECH', name: 'OmniCorp Tech', price: 50.00, volatility: 0.05, owned: 0, history: [] },
            { symbol: 'FOOD', name: 'Burger Queen', price: 25.00, volatility: 0.03, owned: 0, history: [] },
            { symbol: 'OIL', name: 'Dino Fuels', price: 80.00, volatility: 0.02, owned: 0, history: [] },
            { symbol: 'GOLD', name: 'Aurum Holdings', price: 150.00, volatility: 0.08, owned: 0, history: [] }
        ];

        const BOSS_NAMES = ["The Audit", "Market Crash", "Hostile Takeover", "The Regulator", "Bankruptcy", "Federal Indictment"];
        
        // --- QUESTS CONFIGURATION ---
        const QUESTS = [
            {
                id: 'q1',
                title: "The Golden Opportunity",
                desc: "Reach $500 Net Worth to unlock a secret family heirloom.",
                req: (g) => g.money >= 500,
                progress: (g) => Math.min(100, (g.money / 500) * 100),
                rewardType: 'item',
                rewardData: { 
                    name: "Golden Cursor", 
                    icon: "fa-arrow-pointer", 
                    rarity: RARITY.LEGENDARY, 
                    quality: QUALITIES.PRISTINE, 
                    buff: { type: 'click', val: 500 } // OVERPOWERED
                },
                msg: "LEGENDARY ITEM FOUND! +500 Click Power!"
            },
            {
                id: 'q2',
                title: "Seed Capital",
                desc: "Reach $2,500 Net Worth",
                req: (g) => g.money >= 2500,
                progress: (g) => Math.min(100, (g.money / 2500) * 100),
                rewardType: 'money',
                rewardData: 5000,
                msg: "Angel Investor funding received: +$5,000"
            },
            {
                id: 'q3',
                title: "Asset Accumulation",
                desc: "Collect 5 Items in Inventory",
                req: (g) => g.inventory.length >= 5,
                progress: (g) => Math.min(100, (g.inventory.length / 5) * 100),
                rewardType: 'item',
                rewardData: null, // Random briefcase
                msg: "Briefcase awarded for portfolio diversity."
            },
            {
                id: 'q4',
                title: "Market Entry",
                desc: "Buy any Stock in the Exchange",
                req: (g) => g.stocks.some(s => s.owned > 0),
                progress: (g) => g.stocks.some(s => s.owned > 0) ? 100 : 0,
                rewardType: 'money',
                rewardData: 10000,
                msg: "Trading license approved. +$10,000"
            },
            {
                id: 'q5',
                title: "Click Tycoon",
                desc: "Reach 1,000 Click Power",
                req: (g) => g.clickPower >= 1000,
                progress: (g) => Math.min(100, (g.clickPower / 1000) * 100),
                rewardType: 'money',
                rewardData: 50000,
                msg: "Productivity bonus: +$50,000"
            },
            {
                id: 'q6',
                title: "Retirement Plan",
                desc: "Reach $1,000,000 to unlock Prestige",
                req: (g) => g.money >= 1000000,
                progress: (g) => Math.min(100, (g.money / 1000000) * 100),
                rewardType: 'money',
                rewardData: 500000,
                msg: "Golden Parachute secure. +$500,000"
            }
        ];

        STOCKS_DATA.forEach(s => {
            for(let i=0; i<20; i++) s.history.push(s.price);
        });

        /**
         * ------------------------------------------------------------------
         * AUTH & STORAGE SYSTEM
         * ------------------------------------------------------------------
         */
        const auth = {
            users: {},
            init() {
                const storedUsers = localStorage.getItem('corp_climber_users');
                if(storedUsers) this.users = JSON.parse(storedUsers);
            },
            toggle(view) {
                const loginForm = document.getElementById('login-form');
                const regForm = document.getElementById('register-form');
                const err = document.getElementById('auth-error');
                err.classList.add('hidden');
                if(view === 'register') { loginForm.classList.add('hidden'); regForm.classList.remove('hidden'); } 
                else { regForm.classList.add('hidden'); loginForm.classList.remove('hidden'); }
            },
            register() {
                const user = document.getElementById('reg-user').value.trim();
                const pass = document.getElementById('reg-pass').value.trim();
                const err = document.getElementById('auth-error');
                if(user.length < 3 || pass.length < 3) { err.innerText = "Username/Password too short."; err.classList.remove('hidden'); return; }
                if(this.users[user]) { err.innerText = "Username already exists."; err.classList.remove('hidden'); return; }
                this.users[user] = { password: pass, created: Date.now() };
                this.saveUsers();
                this.loginSuccess(user);
            },
            login() {
                const user = document.getElementById('login-user').value.trim();
                const pass = document.getElementById('login-pass').value.trim();
                const err = document.getElementById('auth-error');
                if(!this.users[user] || this.users[user].password !== pass) { err.innerText = "Invalid credentials."; err.classList.remove('hidden'); return; }
                this.loginSuccess(user);
            },
            loginSuccess(username) {
                document.getElementById('auth-screen').classList.add('hidden');
                game.username = username;
                document.getElementById('profile-name').innerText = username;
                game.init();
            },
            logout() { location.reload(); },
            saveUsers() { localStorage.setItem('corp_climber_users', JSON.stringify(this.users)); }
        };

        /**
         * ------------------------------------------------------------------
         * LOGIC HELPERS
         * ------------------------------------------------------------------
         */
        const gameLogic = {
            generateItem(tier, pityActive) {
                let rand = Math.random();
                let rarity = RARITY.COMMON;
                
                let bonus = 0;
                if(tier === 'business') bonus = 0.15;
                if(tier === 'executive') bonus = 0.35;

                // Pity System: Guaranteed Epic or better
                if (pityActive) {
                    if (rand < 0.2) rarity = RARITY.LEGENDARY;
                    else rarity = RARITY.EPIC;
                } else {
                    if(rand < RARITY.LEGENDARY.prob + bonus/5) rarity = RARITY.LEGENDARY;
                    else if(rand < RARITY.EPIC.prob + bonus/3) rarity = RARITY.EPIC;
                    else if(rand < RARITY.RARE.prob + bonus) rarity = RARITY.RARE;
                    else if(rand < RARITY.UNCOMMON.prob + bonus) rarity = RARITY.UNCOMMON;
                }

                // Generate Quality
                let qRand = Math.random();
                let quality = QUALITIES.STANDARD;
                if (qRand > 0.95) quality = QUALITIES.PRISTINE;
                else if (qRand > 0.8) quality = QUALITIES.MINT;
                else if (qRand < 0.1) quality = QUALITIES.SHODDY;

                const baseItem = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                
                const buffType = Math.random() > 0.5 ? 'cps' : 'click';
                let buffAmount = 0;
                // Buff scales with Rarity AND Quality
                let baseVal = buffType === 'click' ? 1 : 5;
                if (rarity.id === 'rare') baseVal *= 5;
                if (rarity.id === 'epic') baseVal *= 15;
                if (rarity.id === 'legendary') baseVal *= 50;
                
                buffAmount = Math.max(1, Math.floor(baseVal * quality.mult * (0.8 + Math.random() * 0.4)));

                return {
                    id: Math.random().toString(36).substr(2,9),
                    name: baseItem.name,
                    icon: baseItem.icon,
                    rarity: rarity,
                    quality: quality,
                    set: baseItem.set,
                    buff: { type: buffType, val: buffAmount }
                };
            }
        };

        /**
         * ------------------------------------------------------------------
         * MOCK BACKEND
         * ------------------------------------------------------------------
         */
        class MockBackend {
            constructor() {
                this.latency = 200; 
                this.marketListings = [];
                this.chatHistory = [
                    { user: "System", text: "Connected to Market Server v9.0", time: Date.now() },
                    { user: "Whale_01", text: "Tech stocks looking bullish ðŸ“ˆ", time: Date.now() - 50000 }
                ];
                this.guilds = {}; // { id: { name, owner, members: [{name, role}], boss: {...}, chat: [], banned: [] } }
                
                // Init some dummy guilds
                this.createGuild("The Golden Bulls", "NPC_Bull", true);
                this.createGuild("Iron Bears", "NPC_Bear", true);

                this.generateMockListings();
                setInterval(() => this.simulateMarketActivity(), 4000);
                setInterval(() => this.simulateChatActivity(), 12000);
                setInterval(() => this.simulateGuildJoins(), 10000); // Bots join player guilds
            }

            async createGuild(name, owner, isSystem = false) {
                await this.delay();
                const id = 'guild_' + Math.random().toString(36).substr(2, 9);
                this.guilds[id] = {
                    id: id,
                    name: name,
                    owner: owner,
                    members: [{ name: owner, role: 'owner' }],
                    moderators: [], // list of names
                    banned: [], // list of names
                    boss: { level: 1, hp: 1000, maxHp: 1000, name: BOSS_NAMES[0] },
                    chat: [{ user: 'System', text: `Guild ${name} created.`, time: Date.now() }],
                    isSystem: isSystem
                };
                return { success: true, guildId: id };
            }

            async joinGuild(guildId, username) {
                await this.delay();
                const g = this.guilds[guildId];
                if(!g) return { success: false, message: "Guild not found" };
                if(g.banned.includes(username)) return { success: false, message: "You are banned from this guild." };
                if(g.members.find(m => m.name === username)) return { success: false, message: "Already a member." };
                
                g.members.push({ name: username, role: 'member' });
                return { success: true, guild: g };
            }

            async leaveGuild(guildId, username) {
                await this.delay();
                const g = this.guilds[guildId];
                if(g) {
                    g.members = g.members.filter(m => m.name !== username);
                    // If owner leaves, random promotion or destroy (simplified: destroy if 0 members)
                    if(g.members.length === 0 && !g.isSystem) delete this.guilds[guildId];
                }
                return { success: true };
            }

            async getGuildData(guildId) {
                await this.delay();
                return this.guilds[guildId];
            }

            async getAllGuilds() {
                await this.delay();
                return Object.values(this.guilds).map(g => ({ id: g.id, name: g.name, memberCount: g.members.length }));
            }

            // --- Guild Management ---
            async kickMember(guildId, target, requestor) {
                const g = this.guilds[guildId];
                if(!g) return;
                g.members = g.members.filter(m => m.name !== target);
                g.chat.push({ user: 'System', text: `${target} was kicked by ${requestor}.`, time: Date.now() });
                return { success: true };
            }

            async banMember(guildId, target, requestor) {
                const g = this.guilds[guildId];
                if(!g) return;
                g.members = g.members.filter(m => m.name !== target);
                g.banned.push(target);
                g.chat.push({ user: 'System', text: `${target} was BANNED by ${requestor}.`, time: Date.now() });
                return { success: true };
            }

            async promoteMember(guildId, target, requestor) {
                const g = this.guilds[guildId];
                if(!g) return;
                const m = g.members.find(x => x.name === target);
                if(m) {
                    m.role = 'mod';
                    g.moderators.push(target);
                    g.chat.push({ user: 'System', text: `${target} was promoted to Moderator.`, time: Date.now() });
                }
                return { success: true };
            }

            async sendGuildMessage(guildId, user, text) {
                const g = this.guilds[guildId];
                if(g) {
                    g.chat.push({ user, text, time: Date.now() });
                    if(g.chat.length > 50) g.chat.shift();
                }
                return { success: true };
            }

            // --- Global Chat/Market ---
            async getListings() { await this.delay(); return [...this.marketListings]; }
            async postListing(listing) { await this.delay(); listing.id = Math.random().toString(36).substr(2, 9); listing.timestamp = Date.now(); this.marketListings.unshift(listing); return { success: true, listingId: listing.id }; }
            async buyItem(listingId) { await this.delay(); const index = this.marketListings.findIndex(l => l.id === listingId); if (index === -1) return { success: false, message: "Item sold or delisted" }; const item = this.marketListings[index]; this.marketListings.splice(index, 1); return { success: true, item: item.itemData }; }
            async getMessages() { return [...this.chatHistory]; }
            async sendMessage(user, text) { const msg = { user, text, time: Date.now() }; this.chatHistory.push(msg); if (this.chatHistory.length > 50) this.chatHistory.shift(); return { success: true }; }
            
            delay(ms) { return new Promise(resolve => setTimeout(resolve, ms || this.latency)); }
            
            generateMockListings() {
                const names = ["DayTrader", "HedgeFund", "Algorithm", "RetailInv"];
                for(let i=0; i<6; i++) {
                    this.marketListings.push({
                        id: Math.random().toString(36).substr(2, 9),
                        seller: names[Math.floor(Math.random() * names.length)],
                        price: Math.floor(Math.random() * 4000) + 200,
                        itemData: gameLogic.generateItem('business', false)
                    });
                }
            }
            simulateMarketActivity() {
                if (this.marketListings.length > 8 && Math.random() > 0.6) {
                    const botListings = this.marketListings.filter(l => l.seller !== game.username);
                    if(botListings.length > 0) this.marketListings = this.marketListings.filter(l => l.id !== botListings[Math.floor(Math.random() * botListings.length)].id);
                }
                if (Math.random() > 0.4) {
                    const names = ["Bot_Alpha", "Trader_X", "WallSt_Guy"];
                    this.marketListings.unshift({
                        id: Math.random().toString(36).substr(2, 9),
                        seller: names[Math.floor(Math.random() * names.length)],
                        price: Math.floor(Math.random() * 8000) + 100,
                        itemData: gameLogic.generateItem('business', false)
                    });
                }
                const playerListings = this.marketListings.filter(l => l.seller === game.username);
                playerListings.forEach(l => {
                    const fairValue = Math.floor(10 * l.itemData.rarity.mult * l.itemData.quality.mult * 2); 
                    const priceRatio = l.price / fairValue;
                    let buyChance = priceRatio < 0.8 ? 0.8 : priceRatio <= 1.1 ? 0.4 : priceRatio <= 1.5 ? 0.1 : 0.01;
                    if (Math.random() < buyChance) {
                        this.marketListings = this.marketListings.filter(item => item.id !== l.id);
                        if(typeof game !== 'undefined' && game.active) game.handleRemoteSale(l.itemData, l.price);
                    }
                });
                if(typeof ui !== 'undefined' && !document.getElementById('tab-market').classList.contains('hidden')) ui.renderMarket();
            }
            simulateChatActivity() {
                const phrases = ["OmniCorp to the moon! ðŸš€", "Just sold my rare watch.", "Anyone want to trade?", "Stocks are crashing...", "Buy the dip!", "Market is volatile!"];
                const users = ["ElonM", "GatesB", "Zuck", "RandomUser", "ApeStrong"];
                this.chatHistory.push({ user: users[Math.floor(Math.random()*users.length)], text: phrases[Math.floor(Math.random()*phrases.length)], time: Date.now() });
                if(typeof ui !== 'undefined' && !document.getElementById('tab-chat').classList.contains('hidden')) ui.renderChat();
            }
            simulateGuildJoins() {
                // Bots join user guilds
                const userGuilds = Object.values(this.guilds).filter(g => !g.isSystem);
                userGuilds.forEach(g => {
                    if(Math.random() > 0.5) {
                        const botNames = ["Intern_Bob", "FinanceBro99", "Wolfie", "StonksMan", "CryptoDad"];
                        const newMember = botNames[Math.floor(Math.random() * botNames.length)] + Math.floor(Math.random()*100);
                        if(!g.members.find(m => m.name === newMember) && !g.banned.includes(newMember)) {
                            g.members.push({ name: newMember, role: 'member' });
                            g.chat.push({ user: 'System', text: `${newMember} joined the guild.`, time: Date.now() });
                            if(typeof ui !== 'undefined' && game.guildId === g.id) {
                                ui.renderGuild(); // Refresh if looking at it
                            }
                        }
                    }
                });
            }
        }
        const api = new MockBackend();

        /**
         * ------------------------------------------------------------------
         * GAME STATE
         * ------------------------------------------------------------------
         */
        const game = {
            active: false,
            money: 0,
            baseClickPower: 1,
            baseCps: 0,
            clickPower: 1,
            cps: 0,
            inventory: [],
            upgradesPurchased: {},
            username: "Guest",
            stocks: JSON.parse(JSON.stringify(STOCKS_DATA)),
            charts: {},
            pendingSaleIndex: null,
            
            // New Features
            influence: 0, // Prestige Currency
            currentQuestIndex: 0,
            pityCounter: 0,
            
            // Juicy features
            critCharge: 0,
            critMax: 50,

            // Guild State
            guildId: null, 
            guildRole: null, 
            guildData: null, 

            init() {
                this.active = true;
                this.load(); 
                this.recalcStats();
                ui.init();
                ui.initStockCharts();

                // Loops
                setInterval(() => { this.addMoney(this.cps / 10); }, 100);
                setInterval(() => { this.updateStocks(); }, 2000);
                setInterval(() => { this.save(); }, 5000);
                setInterval(() => { if(this.guildId) this.syncGuild(); }, 3000);
                
                // Quest Check Loop
                setInterval(() => { this.checkQuest(); }, 1000);
            },

            async syncGuild() {
                const data = await api.getGuildData(this.guildId);
                if(data) {
                    this.guildData = data;
                    const me = data.members.find(m => m.name === this.username);
                    if(!me) {
                        this.guildId = null; 
                        this.guildRole = null;
                        this.guildData = null;
                        ui.showToast("You have been removed from the guild.", "error");
                        ui.renderGuild();
                    } else {
                        this.guildRole = me.role;
                        if(!document.getElementById('tab-guild').classList.contains('hidden')) ui.renderGuild();
                    }
                }
            },

            recalcStats() {
                let addClick = 0;
                let addCps = 0;
                
                // 1. Calculate base item buffs
                this.inventory.forEach(item => {
                    if(item.buff.type === 'click') addClick += item.buff.val;
                    if(item.buff.type === 'cps') addCps += item.buff.val;
                });

                // 2. Set Bonuses
                let multiplier = 1.0;
                const sets = {};
                this.inventory.forEach(item => { if(item.set) sets[item.set] = (sets[item.set] || 0) + 1; });
                
                for(let key in ITEM_SETS) {
                    const setDef = ITEM_SETS[key];
                    if(sets[key] >= setDef.items.length) {
                        multiplier += setDef.bonus;
                    }
                }

                // 3. Prestige Influence (Additive or Multiplicative? Let's go multiplicative for juice)
                const influenceMult = 1 + (this.influence * 0.1); 

                this.clickPower = (this.baseClickPower + addClick) * multiplier * influenceMult;
                this.cps = (this.baseCps + addCps) * multiplier * influenceMult;
                
                ui.updateMoney();
            },

            addMoney(amount) {
                if(!this.active) return;
                this.money += amount;
                // No more checkGoal() here, done via interval now
                ui.updateMoney();
            },

            handleClick(e) {
                if(!this.active) return;
                
                let isCrit = false;
                let dmg = this.clickPower;

                // Crit Logic (Charge System)
                if (this.critCharge >= this.critMax) {
                    isCrit = true;
                    dmg *= 3; // Triple Damage
                    this.critCharge = 0;
                    ui.triggerCritGlow(false); // Turn off glow
                } else {
                    this.critCharge++;
                    if(this.critCharge >= this.critMax) ui.triggerCritGlow(true);
                }
                
                ui.updateCritMeter(this.critCharge, this.critMax);

                this.addMoney(dmg);
                ui.spawnParticles(e.clientX, e.clientY, `+$${Math.floor(dmg).toLocaleString()}`, isCrit);
                
                // Shake effect
                const btn = document.getElementById('click-target');
                btn.style.transform = `scale(0.95) rotate(${Math.random() * 6 - 3}deg)`;
                setTimeout(() => btn.style.transform = 'scale(1) rotate(0deg)', 50);
            },

            checkQuest() {
                const quest = QUESTS[this.currentQuestIndex];
                // Only refresh UI if tab is active to save perf
                if(!document.getElementById('tab-quests').classList.contains('hidden')) {
                    ui.renderQuests(); 
                }
            },
            
            claimQuest() {
                const quest = QUESTS[this.currentQuestIndex];
                if(quest && quest.req(this)) {
                    if(quest.rewardType === 'item') {
                        if(quest.rewardData) {
                            // Specific item (Golden Cursor)
                            const item = JSON.parse(JSON.stringify(quest.rewardData));
                            item.id = Math.random().toString(36).substr(2, 9); // unique id
                            this.inventory.push(item);
                        } else {
                            // Random briefcase
                            const item = gameLogic.generateItem('business', true);
                            this.inventory.push(item);
                        }
                        this.recalcStats();
                        ui.renderInventory();
                    } else if (quest.rewardType === 'money') {
                        this.money += quest.rewardData;
                    }
                    
                    ui.showToast(quest.msg, 'success');
                    this.currentQuestIndex++;
                    ui.renderQuests();
                }
            },

            prestige() {
                if(this.money < 1000000) return;
                if(!confirm("Retire now? You lose Money, Items, and Upgrades but gain Influence. 1 Influence = +10% Income forever.")) return;

                const gain = Math.floor(this.money / 1000000);
                this.influence += gain;
                
                // Reset
                this.money = 0;
                this.baseClickPower = 1;
                this.baseCps = 0;
                this.inventory = [];
                this.upgradesPurchased = {};
                this.currentQuestIndex = 0;
                
                this.recalcStats();
                this.save();
                ui.init(); // Re-render everything
                ui.showToast(`Retired! Gained ${gain} Influence.`, 'success');
            },

            buyUpgrade(upgradeId) {
                const upg = UPGRADES.find(u => u.id === upgradeId);
                const currentLevel = this.upgradesPurchased[upgradeId] || 0;
                const cost = Math.floor(upg.cost * Math.pow(1.5, currentLevel));

                if (this.money >= cost) {
                    this.money -= cost;
                    this.upgradesPurchased[upgradeId] = currentLevel + 1;
                    if(upg.type === 'click') this.baseClickPower += upg.val;
                    if(upg.type === 'cps') this.baseCps += upg.val;
                    this.recalcStats();
                    ui.showToast(`Upgraded: ${upg.name}`, 'success');
                    ui.renderUpgrades();
                } else {
                    ui.showToast("Insufficient Funds", 'error');
                }
            },

            buyBriefcase(tier) {
                let cost = 0;
                if(tier === 'basic') cost = 100;
                if(tier === 'business') cost = 1500;
                if(tier === 'executive') cost = 10000;

                if (this.money >= cost) {
                    this.money -= cost;
                    
                    // Pity Logic
                    this.pityCounter++;
                    const guaranteed = this.pityCounter >= 20;
                    if(guaranteed) this.pityCounter = 0;

                    const item = gameLogic.generateItem(tier, guaranteed);
                    this.inventory.push(item);
                    this.recalcStats();
                    
                    if(guaranteed) ui.showToast(`PITY TRIGGERED: ${item.rarity.id} ${item.name}!`, 'success');
                    else ui.showToast(`Found: ${item.rarity.id} ${item.name}`, 'info');
                    
                    ui.renderInventory();
                    ui.renderRecentLoot();
                    ui.updatePity();
                } else {
                    ui.showToast("Can't afford that case!", 'error');
                }
            },

            sellItem(index) {
                const item = this.inventory[index];
                // Value = Rarity * Quality * 10
                const value = Math.floor(10 * item.rarity.mult * item.quality.mult);
                this.money += value;
                this.inventory.splice(index, 1);
                this.recalcStats();
                ui.showToast(`Sold ${item.name} for $${value}`, 'success');
                ui.renderInventory();
            },

            // --- GUILD ACTIONS ---
            async createGuild() {
                const nameInput = document.getElementById('new-guild-name');
                const name = nameInput.value.trim();
                const cost = 50000;
                if(!name) return ui.showToast("Enter a name", "error");
                if(this.money < cost) return ui.showToast("Insufficient Funds ($50k needed)", "error");
                this.money -= cost;
                ui.showToast("Establishing Headquarters...", "info");
                const res = await api.createGuild(name, this.username);
                if(res.success) { this.guildId = res.guildId; this.guildRole = 'owner'; await this.syncGuild(); ui.renderGuild(); ui.showToast("Guild Created!", "success"); }
            },
            async joinGuild(id) { const res = await api.joinGuild(id, this.username); if(res.success) { this.guildId = id; this.guildRole = 'member'; await this.syncGuild(); ui.renderGuild(); ui.showToast("Joined Guild!", 'success'); } else { ui.showToast(res.message, 'error'); } },
            async leaveGuild() { await api.leaveGuild(this.guildId, this.username); this.guildId = null; this.guildRole = null; this.guildData = null; ui.renderGuild(); ui.renderInventory(); },
            async sendGuildChat() { const input = document.getElementById('guild-chat-input'); const text = input.value.trim(); if(!text) return; await api.sendGuildMessage(this.guildId, this.username, text); input.value = ''; this.syncGuild(); },
            donateItem(index) {
                const item = this.inventory[index];
                const dmg = Math.floor(item.rarity.mult * 100 * item.quality.mult + (item.buff.val * 2));
                this.inventory.splice(index, 1);
                this.recalcStats();
                if(this.guildData) { this.guildData.boss.hp -= dmg; ui.showToast(`Hit boss for ${dmg} DMG!`, 'success'); if (this.guildData.boss.hp <= 0) this.guildBossLevelUp(); else ui.renderGuild(); }
                ui.renderInventory();
            },
            guildBossLevelUp() { const reward = 5000 * this.guildData.boss.level; this.money += reward; const freeItem = gameLogic.generateItem('business', false); this.inventory.push(freeItem); this.recalcStats(); ui.showToast(`BOSS DEFEATED! +$${reward} & Case`, 'success'); this.guildData.boss.level++; this.guildData.boss.maxHp = Math.floor(this.guildData.boss.maxHp * 1.5); this.guildData.boss.hp = this.guildData.boss.maxHp; this.guildData.boss.name = BOSS_NAMES[Math.min(this.guildData.boss.level - 1, BOSS_NAMES.length - 1)] || "Mega Boss"; ui.renderGuild(); ui.renderInventory(); },
            async promoteMember(target) { await api.promoteMember(this.guildId, target, this.username); this.syncGuild(); },
            async kickMember(target) { await api.kickMember(this.guildId, target, this.username); this.syncGuild(); },
            async banMember(target) { await api.banMember(this.guildId, target, this.username); this.syncGuild(); },
            async confirmListing() { if (this.pendingSaleIndex === null) return; const input = document.getElementById('listing-price-input'); const price = parseInt(input.value); if (!price || price <= 0) { ui.showToast("Invalid price", "error"); return; } const item = this.inventory[this.pendingSaleIndex]; ui.closeListingModal(); const response = await api.postListing({ seller: this.username, price: price, itemData: item }); if(response.success) { this.inventory.splice(this.pendingSaleIndex, 1); this.pendingSaleIndex = null; this.recalcStats(); ui.renderInventory(); ui.showToast(`Listed for $${price.toLocaleString()}`, 'success'); ui.renderMarket(); } },
            handleRemoteSale(item, price) { this.money += price; ui.showToast(`ðŸ’° SOLD! ${item.name}`, 'success'); ui.updateMoney(); },
            updateStocks() { if(!this.active) return; this.stocks.forEach(stock => { const changePct = (Math.random() - 0.5) * stock.volatility; stock.price = Math.max(1, stock.price * (1 + changePct)); stock.history.push(stock.price); if(stock.history.length > 20) stock.history.shift(); }); ui.updateStockUI(); },
            buyStock(symbol, amount) { const stock = this.stocks.find(s => s.symbol === symbol); const cost = stock.price * amount; if(this.money >= cost) { this.money -= cost; stock.owned += amount; ui.showToast(`Bought ${amount} ${symbol}`, 'success'); ui.updateMoney(); ui.updateStockUI(); } else { ui.showToast("Not enough cash!", 'error'); } },
            sellStock(symbol, amount) { const stock = this.stocks.find(s => s.symbol === symbol); if(stock.owned >= amount) { this.money += stock.price * amount; stock.owned -= amount; ui.showToast(`Sold ${amount} ${symbol}`, 'success'); ui.updateMoney(); ui.updateStockUI(); } else { ui.showToast("Don't own enough shares!", 'error'); } },
            
            save() {
                if(!this.active) return;
                const data = {
                    money: this.money,
                    baseClickPower: this.baseClickPower, 
                    baseCps: this.baseCps,             
                    inventory: this.inventory,
                    upgradesPurchased: this.upgradesPurchased,
                    stocks: this.stocks.map(s => ({ symbol: s.symbol, owned: s.owned })),
                    guildId: this.guildId,
                    influence: this.influence,
                    currentQuestIndex: this.currentQuestIndex,
                    pityCounter: this.pityCounter,
                    critCharge: this.critCharge // Save crit progress
                };
                localStorage.setItem('corp_climber_save_v6_' + this.username, JSON.stringify(data));
            },
            load() {
                const data = JSON.parse(localStorage.getItem('corp_climber_save_v6_' + this.username));
                if(data) {
                    this.money = data.money || 0;
                    this.baseClickPower = data.baseClickPower || 1;
                    this.baseCps = data.baseCps || 0;
                    this.inventory = data.inventory || [];
                    this.upgradesPurchased = data.upgradesPurchased || {};
                    this.guildId = data.guildId || null;
                    this.influence = data.influence || 0;
                    this.currentQuestIndex = data.currentQuestIndex || 0;
                    this.pityCounter = data.pityCounter || 0;
                    this.critCharge = data.critCharge || 0;
                    if(data.stocks) data.stocks.forEach(savedStock => { const liveStock = this.stocks.find(s => s.symbol === savedStock.symbol); if(liveStock) liveStock.owned = savedStock.owned; });
                } else {
                    this.money = 0; this.baseClickPower = 1; this.baseCps = 0; this.inventory = []; this.upgradesPurchased = {}; this.stocks.forEach(s => s.owned = 0); this.guildId = null; this.influence = 0; this.currentQuestIndex = 0; this.pityCounter = 0; this.critCharge = 0;
                }
            }
        };

        /**
         * ------------------------------------------------------------------
         * UI CONTROLLER
         * ------------------------------------------------------------------
         */
        const ui = {
            init() {
                document.getElementById('click-target').addEventListener('mousedown', (e) => game.handleClick(e));
                document.getElementById('click-target').addEventListener('touchstart', (e) => { e.preventDefault(); game.handleClick(e.touches[0]); }, {passive: false});
                document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') chat.sendMessage(); });
                document.getElementById('login-pass').addEventListener('keypress', (e) => { if(e.key === 'Enter') auth.login(); });
                this.renderUpgrades(); this.renderInventory(); this.renderRecentLoot(); this.updateMoney(); this.renderMarket(); this.renderChat();
                this.renderGuild(); this.renderQuests(); this.updatePity(); this.updateCritMeter(game.critCharge, game.critMax);
            },

            renderQuests() {
                const container = document.getElementById('quest-page-content');
                container.innerHTML = '';

                // Active Quest
                const activeQuest = QUESTS[game.currentQuestIndex];
                if(activeQuest) {
                    const progress = activeQuest.progress(game);
                    const isReady = activeQuest.req(game);
                    
                    const div = document.createElement('div');
                    div.className = `glass-panel p-6 rounded-xl border border-white/10 ${isReady ? 'shadow-[0_0_30px_rgba(34,197,94,0.2)] border-green-500/50' : ''}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-1">Active: ${activeQuest.title}</h3>
                                <p class="text-slate-400">${activeQuest.desc}</p>
                            </div>
                            <div class="bg-slate-800 p-3 rounded-lg border border-white/10">
                                <i class="fa-solid fa-gift text-2xl text-yellow-400"></i>
                            </div>
                        </div>
                        
                        <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden border border-white/10 mb-4">
                            <div class="h-full ${isReady ? 'bg-green-500 animate-pulse' : 'bg-blue-500'} transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-slate-500 font-mono">${Math.floor(progress)}% COMPLETE</div>
                            <button onclick="game.claimQuest()" ${isReady ? '' : 'disabled'} class="px-6 py-2 rounded font-bold text-sm transition-all ${isReady ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}">
                                ${isReady ? 'CLAIM REWARD' : 'IN PROGRESS'}
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                } else {
                    container.innerHTML = `<div class="p-8 text-center text-slate-400 glass-panel rounded-xl">No active contracts available. You run this town now.</div>`;
                }

                // Completed Quests
                const completedDiv = document.createElement('div');
                completedDiv.className = 'mt-8';
                completedDiv.innerHTML = `<h3 class="text-lg font-bold text-slate-400 mb-4 uppercase tracking-widest text-xs">Completed Contracts</h3>`;
                
                let listHtml = '<div class="space-y-2">';
                for(let i = 0; i < game.currentQuestIndex; i++) {
                    const q = QUESTS[i];
                    listHtml += `
                        <div class="flex items-center gap-3 p-3 rounded bg-white/5 border border-white/5 opacity-50">
                            <div class="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center text-green-500 text-xs"><i class="fa-solid fa-check"></i></div>
                            <div class="flex-1 text-sm font-bold text-slate-300 line-through">${q.title}</div>
                        </div>
                    `;
                }
                listHtml += '</div>';
                completedDiv.innerHTML += listHtml;
                container.appendChild(completedDiv);
            },

            updatePity() {
                const percent = (game.pityCounter / 20) * 100;
                document.getElementById('pity-bar').style.width = `${percent}%`;
                document.getElementById('pity-count').innerText = game.pityCounter;
            },

            updateCritMeter(charge, max) {
                const percent = Math.min(100, (charge / max) * 100);
                document.getElementById('crit-bar').style.width = `${percent}%`;
                document.getElementById('crit-text').innerText = `${charge}/${max}`;
                
                if(charge >= max) this.triggerCritGlow(true);
                else this.triggerCritGlow(false);
            },

            triggerCritGlow(active) {
                const glow = document.getElementById('crit-glow');
                const text = document.getElementById('crit-text');
                if(active) {
                    glow.classList.remove('hidden');
                    text.innerText = "READY!";
                    text.classList.add('animate-pulse');
                } else {
                    glow.classList.add('hidden');
                    text.classList.remove('animate-pulse');
                }
            },

            // Updated for quality rendering
            renderInventory() {
                const container = document.getElementById('inventory-grid');
                document.getElementById('inventory-count').innerText = `${game.inventory.length} Items`;
                container.innerHTML = '';
                if(game.inventory.length === 0) { container.innerHTML = `<div class="col-span-full text-center text-slate-500 py-10 italic">Your vault is empty. Purchase briefcases from the Executive Shop.</div>`; }
                else {
                    game.inventory.forEach((item, idx) => {
                        const div = document.createElement('div');
                        div.className = `item-card p-4 rounded-xl flex flex-col items-center gap-3 ${item.rarity.class} relative group cursor-pointer`;
                        const buffText = item.buff.type === 'click' ? `+${item.buff.val} Click` : `+${item.buff.val}/s Income`;
                        const qClass = item.quality ? item.quality.class : 'quality-standard';
                        const qName = item.quality ? item.quality.name : 'Standard';

                        div.innerHTML = `
                            <div class="w-10 h-10 rounded-full bg-slate-900/50 flex items-center justify-center text-xl text-white/80"><i class="fa-solid ${item.icon}"></i></div>
                            <div class="text-center w-full">
                                <div class="text-xs font-bold text-white truncate w-full">${item.name}</div>
                                <div class="text-[10px] uppercase tracking-wider opacity-75 font-semibold mt-1">${item.rarity.id}</div>
                                <div class="text-[9px] ${qClass} uppercase tracking-widest mt-0.5">${qName}</div>
                                <div class="text-[10px] font-mono text-neonGreen mt-1 bg-black/20 rounded px-1">${buffText}</div>
                            </div>
                            <div class="absolute inset-0 bg-slate-900/95 backdrop-blur-sm rounded-xl flex flex-col items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity p-2 z-10">
                                <button onclick="game.sellItem(${idx})" class="w-full py-2 bg-red-600 hover:bg-red-500 rounded text-xs font-bold text-white shadow-lg">Sell ($${Math.floor(10*item.rarity.mult*(item.quality?item.quality.mult:1))})</button>
                                <button onclick="ui.openListingModal(${idx})" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold text-white shadow-lg">Trade</button>
                                ${game.guildId ? `<button onclick="game.donateItem(${idx})" class="w-full py-2 bg-orange-600 hover:bg-orange-500 rounded text-xs font-bold text-white shadow-lg">Donate</button>` : ''}
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }

                // Render Collection Sets
                const setsContainer = document.getElementById('collection-summary');
                const ownedItems = new Set(game.inventory.map(i => i.name));
                let setsHtml = '';
                for(let key in ITEM_SETS) {
                    const set = ITEM_SETS[key];
                    const ownedCount = set.items.filter(i => ownedItems.has(i)).length;
                    const isComplete = ownedCount === set.items.length;
                    setsHtml += `
                        <div class="min-w-[120px] p-2 rounded bg-slate-800 border ${isComplete ? 'border-neonGold' : 'border-slate-700'} flex flex-col items-center text-center">
                            <div class="text-[10px] uppercase font-bold text-slate-400">${set.name}</div>
                            <div class="text-xs font-mono my-1 ${isComplete ? 'text-neonGold' : 'text-slate-500'}">${ownedCount}/${set.items.length}</div>
                            <div class="text-[9px] text-green-400">${set.desc}</div>
                        </div>
                    `;
                }
                setsContainer.innerHTML = setsHtml;
            },

            // --- Unchanged Functions (Shortened for brevity but functionally identical) ---
            renderGuild() {
                const container = document.getElementById('guild-container');
                if(!game.guildId || !game.guildData) {
                    api.getAllGuilds().then(guilds => {
                        let html = `
                            <div class="glass-panel p-6 rounded-xl flex flex-col items-center mb-6">
                                <h3 class="text-xl font-bold text-white mb-2">Create Your Firm</h3>
                                <p class="text-sm text-slate-400 mb-4">Start your own guild for $50,000</p>
                                <div class="flex gap-2 w-full max-w-sm">
                                    <input type="text" id="new-guild-name" placeholder="Guild Name" class="flex-1 bg-slate-900 border border-slate-700 rounded px-3 text-white">
                                    <button onclick="game.createGuild()" class="bg-green-600 hover:bg-green-500 text-white font-bold px-4 py-2 rounded">Create</button>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-4">Existing Guilds</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        `;
                        guilds.forEach(g => { html += `<div class="glass-panel p-4 rounded-lg flex justify-between items-center hover:bg-white/5"><div><div class="font-bold text-white">${g.name}</div><div class="text-xs text-slate-400">${g.memberCount} Members</div></div><button onclick="game.joinGuild('${g.id}')" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm text-white font-bold">Join</button></div>`; });
                        html += `</div>`;
                        container.innerHTML = html;
                    });
                    return;
                }
                const g = game.guildData;
                const hpPercent = (g.boss.hp / g.boss.maxHp) * 100;
                const isOwner = game.guildRole === 'owner'; const isMod = game.guildRole === 'mod' || isOwner;
                let chatHtml = g.chat.map(m => `<div class="text-xs mb-1"><span class="text-slate-500">[${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}]</span> <span class="font-bold ${m.user === 'System' ? 'text-yellow-400' : 'text-blue-400'}">${m.user}:</span> <span class="text-slate-300">${m.text}</span></div>`).join('');
                let membersHtml = g.members.map(m => {
                    let actions = '';
                    if(m.name !== game.username) { if(isOwner && m.role !== 'mod') actions += `<button onclick="game.promoteMember('${m.name}')" class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded ml-1">Promote</button>`; if(isMod) actions += `<button onclick="game.kickMember('${m.name}')" class="text-[10px] bg-red-500/20 text-red-400 px-2 py-1 rounded ml-1">Kick</button>`; if(isOwner) actions += `<button onclick="game.banMember('${m.name}')" class="text-[10px] bg-red-900/50 text-red-500 px-2 py-1 rounded ml-1">Ban</button>`; }
                    return `<div class="flex justify-between items-center py-2 border-b border-white/5"><div><span class="font-bold ${m.role === 'owner' ? 'text-yellow-400' : m.role === 'mod' ? 'text-green-400' : 'text-white'}">${m.name}</span><span class="text-xs text-slate-500 ml-1">(${m.role})</span></div><div class="flex">${actions}</div></div>`;
                }).join('');
                container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full"><div class="lg:col-span-2 flex flex-col"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-white">${g.name}</h2><button onclick="game.leaveGuild()" class="text-xs text-red-400 underline">Leave</button></div><div class="flex-1 glass-panel rounded-xl p-6 flex flex-col items-center justify-center relative mb-4"><h3 class="text-red-500 font-black text-2xl uppercase tracking-widest mb-2">${g.boss.name}</h3><p class="text-xs text-slate-400 mb-6">Level ${g.boss.level}</p><div id="boss-img" class="w-32 h-32 bg-slate-800 rounded-full flex items-center justify-center border-4 border-red-500 mb-6 shadow-[0_0_30px_rgba(239,68,68,0.4)]"><i class="fa-solid fa-dragon text-5xl text-red-500"></i></div><div class="w-full bg-slate-900 h-6 rounded-full overflow-hidden relative border border-white/10"><div class="h-full bg-gradient-to-r from-red-600 to-orange-600" style="width: ${hpPercent}%"></div><div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white shadow-black drop-shadow-md">${Math.max(0, g.boss.hp).toLocaleString()} / ${g.boss.maxHp.toLocaleString()}</div></div><p class="text-xs text-slate-400 mt-4 animate-pulse">Use items from Inventory to Attack</p></div></div><div class="flex flex-col gap-4 overflow-hidden h-full"><div class="flex-1 glass-panel rounded-xl overflow-hidden flex flex-col h-1/2"><div class="bg-white/5 p-2 font-bold text-xs text-slate-300 uppercase tracking-widest">Members (${g.members.length})</div><div class="flex-1 overflow-y-auto p-2">${membersHtml}</div></div><div class="flex-1 glass-panel rounded-xl overflow-hidden flex flex-col h-1/2"><div class="bg-white/5 p-2 font-bold text-xs text-slate-300 uppercase tracking-widest">Guild Comms</div><div class="flex-1 overflow-y-auto p-2" id="guild-chat-log">${chatHtml}</div><div class="p-2 border-t border-white/5 flex gap-1"><input type="text" id="guild-chat-input" class="w-full bg-black/20 rounded px-2 py-1 text-xs text-white" placeholder="Msg..."><button onclick="game.sendGuildChat()" class="bg-blue-600 text-white px-2 rounded text-xs"><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div>`;
                const chatLog = document.getElementById('guild-chat-log'); if(chatLog) chatLog.scrollTop = chatLog.scrollHeight;
                const gInput = document.getElementById('guild-chat-input'); if(gInput) gInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') game.sendGuildChat(); });
            },

            spawnParticles(x, y, text, isCrit) {
                const el = document.createElement('div');
                el.className = isCrit ? 'crit-particle text-3xl font-black' : 'click-particle text-2xl text-green-400 font-mono';
                el.style.left = `${x}px`; el.style.top = `${y}px`; el.innerText = text + (isCrit ? '!' : '');
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 800);
            },
            updateMoney() {
                document.getElementById('money-display').innerText = Math.floor(game.money).toLocaleString();
                document.getElementById('cps-display').innerText = game.cps.toFixed(1);
                document.getElementById('click-power-display').innerText = game.clickPower.toFixed(0);
                document.getElementById('influence-display').innerText = `${game.influence} Influence`;
                const stockVal = game.stocks.reduce((acc, s) => acc + (s.price * s.owned), 0);
                document.getElementById('portfolio-val').innerText = Math.floor(stockVal).toLocaleString();
                
                // Show/Hide Prestige Button
                if(game.money >= 1000000) document.getElementById('prestige-btn').classList.remove('hidden');
                else document.getElementById('prestige-btn').classList.add('hidden');
            },
            initStockCharts() {
                const container = document.getElementById('stock-container'); container.innerHTML = '';
                game.stocks.forEach((stock, index) => {
                    const card = document.createElement('div'); card.className = 'glass-panel p-4 rounded-xl border border-white/5 bg-slate-800/50';
                    card.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-lg text-white">${stock.name} <span class="text-xs text-slate-500 ml-2 font-mono">${stock.symbol}</span></h3><div class="text-xs text-slate-400">Owned: <span id="stock-owned-${index}" class="text-white font-mono font-bold">${stock.owned}</span></div></div><div class="text-right"><div id="stock-price-${index}" class="text-xl font-mono font-bold text-white">$${stock.price.toFixed(2)}</div><div id="stock-change-${index}" class="text-xs font-mono">0.00%</div></div></div><div class="h-32 w-full mb-4"><canvas id="chart-${index}"></canvas></div><div class="grid grid-cols-2 gap-2"><button onclick="game.buyStock('${stock.symbol}', 1)" class="bg-green-600/20 hover:bg-green-600/40 text-green-400 border border-green-600/50 py-1 rounded font-bold text-xs transition-colors">Buy 1</button><button onclick="game.sellStock('${stock.symbol}', 1)" class="bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-600/50 py-1 rounded font-bold text-xs transition-colors">Sell 1</button><button onclick="game.buyStock('${stock.symbol}', 10)" class="bg-green-600/20 hover:bg-green-600/40 text-green-400 border border-green-600/50 py-1 rounded font-bold text-xs transition-colors">Buy 10</button><button onclick="game.sellStock('${stock.symbol}', 10)" class="bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-600/50 py-1 rounded font-bold text-xs transition-colors">Sell 10</button></div>`;
                    container.appendChild(card);
                    const ctx = document.getElementById(`chart-${index}`).getContext('2d');
                    game.charts[stock.symbol] = new Chart(ctx, { type: 'line', data: { labels: Array(20).fill(''), datasets: [{ data: stock.history, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false, grace: '5%' } }, animation: false } });
                });
            },
            updateStockUI() {
                game.stocks.forEach((stock, index) => {
                    const priceEl = document.getElementById(`stock-price-${index}`);
                    if(priceEl) {
                        priceEl.innerText = `$${stock.price.toFixed(2)}`;
                        document.getElementById(`stock-owned-${index}`).innerText = stock.owned;
                        const prev = stock.history[stock.history.length - 2];
                        const change = ((stock.price - prev) / prev) * 100;
                        const changeEl = document.getElementById(`stock-change-${index}`);
                        changeEl.innerText = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                        changeEl.className = `text-xs font-mono ${change >= 0 ? 'text-green-400' : 'text-red-400'}`;
                        const chart = game.charts[stock.symbol];
                        chart.data.datasets[0].data = stock.history;
                        chart.data.datasets[0].borderColor = change >= 0 ? '#22c55e' : '#ef4444';
                        chart.data.datasets[0].backgroundColor = change >= 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                        chart.update();
                    }
                });
                const stockVal = game.stocks.reduce((acc, s) => acc + (s.price * s.owned), 0);
                const pvEl = document.getElementById('portfolio-val'); if(pvEl) pvEl.innerText = Math.floor(stockVal).toLocaleString();
            },
            renderUpgrades() {
                const container = document.getElementById('upgrades-list'); container.innerHTML = '';
                UPGRADES.forEach(u => {
                    const level = game.upgradesPurchased[u.id] || 0;
                    const cost = Math.floor(u.cost * Math.pow(1.5, level));
                    const div = document.createElement('div'); div.className = 'glass-panel p-4 rounded-xl flex items-center justify-between hover:bg-white/5 transition-colors group';
                    div.innerHTML = `<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-lg bg-slate-800 flex items-center justify-center text-blue-400 group-hover:text-white transition-colors border border-white/10"><i class="fa-solid ${u.icon} text-xl"></i></div><div><h4 class="font-bold text-slate-200">${u.name} <span class="text-xs text-blue-400 ml-1">Lvl ${level}</span></h4><p class="text-xs text-slate-400">${u.desc}</p></div></div><button onclick="game.buyUpgrade('${u.id}')" class="bg-blue-600/20 hover:bg-blue-600 hover:text-white border border-blue-500/50 text-blue-400 px-4 py-2 rounded-lg text-xs font-bold min-w-[90px] transition-all">$${cost.toLocaleString()}</button>`;
                    container.appendChild(div);
                });
            },
            renderRecentLoot() {
                const container = document.getElementById('recent-loot'); const recent = game.inventory.slice(-8).reverse(); if(recent.length === 0) return; container.innerHTML = '';
                recent.forEach(item => {
                    const div = document.createElement('div'); div.className = `min-w-[40px] h-[40px] rounded border flex items-center justify-center text-sm ${item.rarity.class}`; div.innerHTML = `<i class="fa-solid ${item.icon}"></i>`;
                    container.appendChild(div);
                });
            },
            async renderMarket() {
                const listings = await api.getListings(); const container = document.getElementById('market-listings'); container.innerHTML = '';
                if(listings.length === 0) { container.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-500 italic">No active listings available. Check back later.</td></tr>`; return; }
                listings.forEach(l => {
                    const tr = document.createElement('tr'); tr.className = 'hover:bg-white/5 transition-colors border-b border-white/5 group';
                    const buffText = l.itemData.buff.type === 'click' ? `+${l.itemData.buff.val} Click` : `+${l.itemData.buff.val}/s`;
                    tr.innerHTML = `<td class="p-3"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded border flex items-center justify-center ${l.itemData.rarity.class}"><i class="fa-solid ${l.itemData.icon}"></i></div><div><div class="font-bold text-sm text-slate-200">${l.itemData.name}</div><div class="flex gap-2 text-[10px]"><span class="${l.itemData.rarity.color} font-bold tracking-wider">${l.itemData.rarity.id.toUpperCase()}</span><span class="text-green-400 font-mono">${buffText}</span></div></div></div></td><td class="p-3 text-slate-400 text-xs font-mono hidden sm:table-cell">${l.seller}</td><td class="p-3 font-mono text-green-400 font-bold">$${l.price.toLocaleString()}</td><td class="p-3 text-right"><button onclick="market.buyListing('${l.id}', ${l.price})" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-4 py-2 rounded shadow-lg shadow-green-900/20 transform active:scale-95 transition-all">BUY</button></td>`;
                    container.appendChild(tr);
                });
            },
            async renderChat() {
                const msgs = await api.getMessages(); const container = document.getElementById('chat-messages'); container.innerHTML = '';
                msgs.forEach(m => {
                    const div = document.createElement('div'); div.className = 'text-sm flex gap-2 animate-fade-in';
                    const time = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    div.innerHTML = `<span class="text-slate-600 text-xs whitespace-nowrap pt-1">${time}</span><div><span class="font-bold ${m.user === game.username ? 'text-blue-400' : 'text-slate-300'} mr-1">${m.user}:</span><span class="text-slate-400">${m.text}</span></div>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            },
            openListingModal(index) {
                game.pendingSaleIndex = index; const item = game.inventory[index];
                document.getElementById('modal-item-name').innerText = item.name;
                document.getElementById('modal-item-name').className = `font-bold ${item.rarity.color}`;
                document.getElementById('modal-fair-val').innerText = '$' + (Math.floor(10 * item.rarity.mult * (item.quality?item.quality.mult:1))).toLocaleString();
                document.getElementById('listing-price-input').value = Math.floor(10 * item.rarity.mult * (item.quality?item.quality.mult:1));
                document.getElementById('listing-modal').classList.remove('hidden'); document.getElementById('listing-price-input').focus();
            },
            closeListingModal() { game.pendingSaleIndex = null; document.getElementById('listing-modal').classList.add('hidden'); },
            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container'); const div = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500/90 text-white' : type === 'success' ? 'bg-green-500/90 text-white' : 'bg-slate-700/90 text-slate-200';
                div.className = `${colors} backdrop-blur px-6 py-4 rounded-lg shadow-2xl text-sm font-bold flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0`;
                let icon = type === 'error' ? 'fa-circle-exclamation' : type === 'success' ? 'fa-circle-check' : 'fa-circle-info';
                div.innerHTML = `<i class="fa-solid ${icon}"></i> ${msg}`; container.appendChild(div);
                requestAnimationFrame(() => { div.classList.remove('translate-y-10', 'opacity-0'); });
                setTimeout(() => { div.classList.add('translate-y-4', 'opacity-0'); setTimeout(() => div.remove(), 300); }, 3000);
            }
        };

        const market = {
            refreshListings() { ui.renderMarket(); ui.showToast("Market Data Refreshed", 'info'); },
            async buyListing(id, price) {
                if(game.money >= price) {
                    const res = await api.buyItem(id);
                    if(res.success) {
                        game.money -= price; game.inventory.push(res.item); game.recalcStats();
                        ui.showToast(`Acquired: ${res.item.name}`, 'success'); ui.updateMoney(); ui.renderInventory(); ui.renderMarket();
                    } else { ui.showToast(res.message, 'error'); ui.renderMarket(); }
                } else { ui.showToast("Insufficient Funds", 'error'); }
            }
        };

        const chat = {
            async sendMessage() {
                const input = document.getElementById('chat-input'); const text = input.value.trim(); if(!text) return;
                await api.sendMessage(game.username, text); input.value = ''; ui.renderChat();
            }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('text-blue-400', 'border-blue-500'); btn.classList.add('text-slate-400', 'border-transparent'); });
            const activeBtn = document.querySelector(`button[data-tab="${tabName}"]`);
            activeBtn.classList.remove('text-slate-400', 'border-transparent'); activeBtn.classList.add('text-blue-400', 'border-blue-500');
            if(tabName === 'market') ui.renderMarket(); if(tabName === 'chat') ui.renderChat(); if(tabName === 'guild') ui.renderGuild(); if(tabName === 'quests') ui.renderQuests();
            if(tabName === 'stocks') { setTimeout(() => { Object.values(game.charts).forEach(chart => chart.resize()); }, 100); }
        }

        auth.init();
    </script>
</body>
</html>
